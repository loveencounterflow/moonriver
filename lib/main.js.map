{
  "version": 3,
  "file": "",
  "sourceRoot": "",
  "sources": [
    "../src/main.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n'use strict'\n\n\n############################################################################################################\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'MOONRIVER'\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\ninfo                      = CND.get_logger 'info',      badge\nurge                      = CND.get_logger 'urge',      badge\nhelp                      = CND.get_logger 'help',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\necho                      = CND.echo.bind CND\nGUY                       = require 'guy'\ntypes                     = new ( require 'intertype' ).Intertype()\n{ isa\n  type_of\n  validate }              = types\n# { Moonriver }             = require '../../../apps/moonriver'\nUTIL                      = require 'util'\n\n#-----------------------------------------------------------------------------------------------------------\nsymbol                    = GUY.lft.freeze\n  misfit:     Symbol.for 'misfit' # indicates missing value\n  drop:       Symbol.for 'drop'   # this value will not go to output\n  exit:       Symbol.for 'exit'   # exit pipeline processing\n  # done:       Symbol.for 'done' # done for this iteration\n  over:       Symbol.for 'over'   # do not call again in this round\n\n#-----------------------------------------------------------------------------------------------------------\nadd_length_prop = ( target, key ) ->\n  GUY.props.def target, 'length',\n    get:        -> @[ key ].length\n    set: ( x )  -> @[ key ].length = x\n\n#-----------------------------------------------------------------------------------------------------------\npluck = ( o, k, fallback = symbol.misfit ) ->\n  R = o[ k ]\n  delete o[ k ]\n  if R is undefined\n    return fallback unless fallback is symbol.misfit\n    throw new Error \"^moonriver@1^ unknown property #{rpr k}\"\n  return R\n\n\n\n#===========================================================================================================\n#\n#-----------------------------------------------------------------------------------------------------------\ntypes.declare 'mrv_modifiers', tests:\n  \"@isa.object x\":                        ( x ) -> @isa.object x\n  \"@isa.boolean x.is_source\":             ( x ) -> @isa.boolean x.is_source\n  \"@isa.boolean x.once_before_first\":     ( x ) -> @isa.boolean x.once_before_first\n  \"@isa.boolean x.once_after_last\":       ( x ) -> @isa.boolean x.once_after_last\n\n\n#===========================================================================================================\n#\n#-----------------------------------------------------------------------------------------------------------\nclass Duct\n\n  #---------------------------------------------------------------------------------------------------------\n  @C: GUY.lft.freeze\n    defaults:\n      constructor:\n        on_change:    null\n        is_oblivious: false\n\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ( cfg ) ->\n    cfg           = { @constructor.C.defaults.constructor..., cfg..., }\n    @is_oblivious = pluck cfg, 'is_oblivious'\n    @on_change    = pluck cfg, 'on_change'\n    @cfg          = GUY.lft.freeze @cfg\n    @d            = []\n    @transform    = null ### transform to be called when data arrives ###\n    @prv_length   = 0\n    add_length_prop @, 'd'\n    return undefined\n\n  #---------------------------------------------------------------------------------------------------------\n  _on_change: ->\n    delta       = @length - @prv_length\n    @prv_length = @length\n    @on_change? delta\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  set_oblivious: ( onoff ) ->\n    validate.boolean onoff\n    throw new Error \"^moonriver@2^ cannot set to oblivious unless duct is empty\" if onoff and @length > 0\n    @is_oblivious = onoff\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  push: ( x ) ->\n    return null if @is_oblivious\n    R = @d.push x\n    @_on_change()\n    return R\n\n  #---------------------------------------------------------------------------------------------------------\n  pop: ( fallback = symbols.misfit ) ->\n    if @d.length is 0\n      return fallback unless fallback is symbols.misfit\n      throw new Error \"^moonriver@3^ cannot pop() from empty list\"\n    R = @d.pop()\n    @_on_change()\n    return R\n\n  #---------------------------------------------------------------------------------------------------------\n  unshift: ( x ) ->\n    return null if @is_oblivious\n    R = @d.unshift x\n    @_on_change()\n    return R\n\n  #---------------------------------------------------------------------------------------------------------\n  shift: ( fallback = symbols.misfit ) ->\n    if @d.length is 0\n      return fallback unless fallback is symbols.misfit\n      throw new Error \"^moonriver@4^ cannot shift() from empty list\"\n    return null if @is_oblivious\n    R = @d.shift()\n    @_on_change()\n    return R\n\n  #---------------------------------------------------------------------------------------------------------\n  clear: ->\n    @d.length = 0\n    @_on_change()\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  [Symbol.iterator]: -> yield d for d in @d; return null\n\n  #---------------------------------------------------------------------------------------------------------\n  toString:               ->\n    return '[X]' if @is_oblivious\n    return ( rpr @d ) # + ' ➡︎ ' + ( @transform?.name ? './.' )\n  [UTIL.inspect.custom]:  -> @toString()\n\n\n#===========================================================================================================\n#\n#-----------------------------------------------------------------------------------------------------------\nclass Segment\n\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ( raw_transform, idx ) ->\n  # constructor: ( modifiers..., raw_transform ) ->\n  #   throw new Error \"^segment@1^ modifiers not implemented\" if modifiers.length > 0\n    @idx              = idx\n    @call_count       = 0\n    @input            = null\n    @output           = null\n    @modifiers        = null\n    @arity            = null\n    @_is_over         = false\n    @has_exited       = false\n    # @is_listener      = false\n    @is_sender        = false\n    @is_source        = false\n    @transform        = @_transform_from_raw_transform raw_transform\n    GUY.props.def @, '_has_input_data', get: => @input.length > 0\n    GUY.props.def @, 'is_over',         get: => @_is_over\n    return undefined\n\n  #---------------------------------------------------------------------------------------------------------\n  set_input: ( duct ) ->\n    @input = duct\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  set_output: ( duct ) ->\n    @output = duct\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  set_is_over: ( onoff ) ->\n    validate.boolean onoff\n    @_is_over = onoff\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  set_call_count: ( call_count ) ->\n    validate.cardinal call_count\n    @call_count = call_count\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _transfer: ->\n    @output.push @input.shift() while @input.length > 0\n    return null\n\n  #=========================================================================================================\n  #\n  #---------------------------------------------------------------------------------------------------------\n  _transform_from_raw_transform: ( raw_transform ) ->\n    { is_sender\n      is_source\n      is_repeatable\n      modifiers\n      transform     } = @_get_transform raw_transform\n    @arity            = transform.length\n    # @is_listener       = not ( modifiers.do_once_before or modifiers.do_once_after )\n    ### TAINT do not treat modifier `is_source` different from others ###\n    @is_source        = is_source or ( pluck modifiers, 'is_source', false )\n    @modifiers        = modifiers\n    @is_sender        = is_sender\n    @is_repeatable    = is_repeatable\n    #...................................................................................................\n    if @is_sender\n      if @modifiers.once_before_first or @modifiers.once_after_last\n        @call = ( d ) =>\n          @call_count++\n          @transform @send\n          return null\n      else\n        @call = ( d ) =>\n          @call_count++\n          @transform @modifiers.first, @send if ( @call_count is 1 ) and @modifiers.do_first\n          @transform d, @send\n          return null\n    #...................................................................................................\n    else\n      @call = ( d ) =>\n        @call_count++\n        @transform @modifiers.first if ( @call_count is 1 ) and @modifiers.do_first\n        @transform d\n        @send d\n        return null\n    #...................................................................................................\n    @send = ( d ) =>\n      switch d\n        when symbol.drop  then  null\n        when symbol.over  then  @set_is_over true\n        when symbol.exit  then  @has_exited = true\n        else\n          if @is_over\n            throw new Error \"^moonriver@5^ cannot send values after pipeline has terminated; \" \\\n              + \"error occurred in segment idx #{@idx} (#{rpr @_name_of_transform()})\"\n          @output.push d\n      return null\n    #...................................................................................................\n    @send.symbol      = symbol\n    @send.over        = => @send symbol.over\n    @send.exit        = => @send symbol.exit\n    # GUY.props.hide segment, 'send', send\n    # GUY.props.hide segment, 'call', call\n    # @pipeline.push        segment\n    # @on_once_before.push  segment if modifiers.do_once_before\n    # @on_once_after.push   segment if modifiers.do_once_after\n    # @on_last.push         segment if modifiers.do_last\n    # @sources.push         segment if is_source\n    # @inputs.push    input\n    return transform\n\n  #=========================================================================================================\n  #\n  #---------------------------------------------------------------------------------------------------------\n  _get_transform: ( raw_transform ) ->\n    if ( type_of raw_transform ) is 'modified_transform'\n      modifiers = raw_transform.modifiers\n      transform = @_get_transform_2 raw_transform.transform, modifiers\n    else\n      modifiers = {}\n      transform = @_get_transform_2 raw_transform, modifiers\n    #.......................................................................................................\n    return { modifiers, transform..., }\n\n  #---------------------------------------------------------------------------------------------------------\n  _get_transform_2: ( raw_transform, modifiers ) ->\n    is_source     = false\n    is_sender     = true\n    is_repeatable = true\n    switch type = type_of raw_transform\n      when 'function'\n        switch ( arity = raw_transform.length )\n          when 1\n            is_sender = modifiers.once_after_last is true\n            transform = raw_transform\n          when 2\n            if modifiers.once_before_first or modifiers.once_after_last\n              throw new Error \"^moonriver@6^ transform with arity 2 not implemented for modifiers \" \\\n                + \"once_before_first, once_after_last\"\n            transform = raw_transform\n          else\n            throw new Error \"^moonriver@7^ transform with arity #{arity} not implemented\"\n      when 'generatorfunction'\n        is_source       = true\n        transform       = @_source_from_generatorfunction raw_transform\n        unless ( arity = transform.length ) is 2\n          throw new Error \"^moonriver@8^ expected function with arity 2 got one with arity #{arity}\"\n      when 'list'\n        is_source       = true\n        transform       = @_source_from_list raw_transform\n      else\n        if ( type is 'generator' ) or ( isa.function raw_transform[ Symbol.iterator ] )\n          is_repeatable   = false\n          is_source       = true\n          transform       = @_source_from_generator raw_transform\n          unless ( arity = transform.length ) is 2\n            throw new Error \"^moonriver@9^ expected function with arity 2 got one with arity #{arity}\"\n        else\n          throw new Error \"^moonriver@10^ cannot convert a #{type} to a source\"\n    transform = transform.bind @\n    return { is_sender, is_source, is_repeatable, transform, }\n\n  #---------------------------------------------------------------------------------------------------------\n  _source_from_generatorfunction: ( generatorfunction ) ->\n    generator = null\n    return genfΔ = ( d, send ) ->\n      generator ?= generatorfunction()\n      send d unless d is symbol.drop\n      { value\n        done  } = generator.next()\n      ### NOTE silently discards value of `return` where present in keeping with JS `for of` loops ###\n      return send value unless done\n      generator = null\n      send.over()\n      return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _source_from_generator: ( generator ) ->\n    return genΔ = ( d, send ) ->\n      send d unless d is symbol.drop\n      { value\n        done  } = generator.next()\n      ### NOTE silently discards value of `return` where present in keeping with JS `for of` loops ###\n      return send value unless done\n      send.over()\n      return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _source_from_list: ( list ) ->\n    last_idx  = list.length - 1\n    idx       = -1\n    return listΔ = ( d, send ) ->\n      send d unless d is symbol.drop\n      idx++\n      if idx > last_idx\n        idx = -1\n        return send.over()\n      send list[ idx ]\n      return null\n\n  #=========================================================================================================\n  #\n  #---------------------------------------------------------------------------------------------------------\n  _name_of_transform: ->\n    return '???'    unless @transform?\n    return '(anon)' unless @transform.name?\n    return @transform.name.replace /^bound /, ''\n\n  #---------------------------------------------------------------------------------------------------------\n  [UTIL.inspect.custom]:  -> @toString()\n  toString:               ->\n    parts = []\n    parts.push ( rpr @input ) + ' ➡︎ '\n    parts.push @_name_of_transform() + ' ➡︎ ' + ( rpr @output )\n    return parts.join ' '\n\n\n#===========================================================================================================\n#\n#-----------------------------------------------------------------------------------------------------------\nclass Modified_transform\n\n  #---------------------------------------------------------------------------------------------------------\n  @C = GUY.lft.freeze\n    known_modifications: new Set [\n      'is_source',\n      'first', 'last',\n      'once_after_last', 'once_before_first', ]\n\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ( modifiers..., transform ) ->\n    defaults    =\n      is_source:          false\n      once_before_first:  false\n      once_after_last:    false\n      first:              undefined\n      last:               undefined\n    @modifiers  = { defaults..., ( Object.assign {}, modifiers... )..., }\n    validate.mrv_modifiers @modifiers\n    for key of @modifiers\n      continue if @constructor.C.known_modifications.has key\n      throw new Error \"^moonriver@11^ unknown modifiers key #{rpr key}\"\n    # @modifiers.do_first       = true if @modifiers.first        isnt undefined\n    # @modifiers.do_last        = true if @modifiers.last         isnt undefined\n    @transform = transform\n    return undefined\n\n\n#===========================================================================================================\n#\n#-----------------------------------------------------------------------------------------------------------\nclass Moonriver\n\n  #---------------------------------------------------------------------------------------------------------\n  @$: ( modifiers..., transform ) -> new Modified_transform modifiers..., transform\n\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ( transforms = null ) ->\n    @data_count           = 0\n    @segments             = []\n    @turns                = 0\n    @inputs               = []\n    @sources              = []\n    # @on_last        = []\n    # @on_once_before = []\n    ### TAINT not a good name for a collection of segments ###\n    @on_once_before_first = []\n    @on_once_after_last   = []\n    @user                 = {} ### user area for sharing state between transforms, etc ###\n    add_length_prop @, 'segments'\n    @push transform for transform from transforms if transforms?\n    #.......................................................................................................\n    GUY.props.def @, 'sources_are_repeatable',  get: => @sources.every ( x ) -> x.is_repeatable\n    GUY.props.def @, 'can_repeat',              get: => @turns is 0 or @is_repeatable\n    GUY.props.def @, 'first_segment',           get: => @segments[ 0 ]\n    GUY.props.def @, 'last_segment',            get: => @segments[ @segments.length - 1 ]\n    #.......................................................................................................\n    return undefined\n\n  #---------------------------------------------------------------------------------------------------------\n  push: ( transform ) ->\n    segment = new Segment transform, @segments.length\n    #.......................................................................................................\n    if segment.modifiers.once_before_first or segment.modifiers.once_after_last\n      if segment.modifiers.once_before_first then @push bfirst = ( d, send ) -> send d\n      else                                        @push alast  = ( d, send ) -> send d\n      segment.set_output @last_segment.input\n      @on_once_before_first.push segment\n    #.......................................................................................................\n    else\n      if ( last_segment = @last_segment )?\n        segment.set_input last_segment.output\n        last_segment.output.set_oblivious false\n      else\n        segment.set_input new Duct { on_change: @on_change, }\n      segment.set_output new Duct { on_change: @on_change, is_oblivious: true, }\n      @segments.push segment\n    #.......................................................................................................\n    @sources.push segment if segment.is_source\n    return segment\n\n  #---------------------------------------------------------------------------------------------------------\n  on_change: ( delta ) =>\n    @data_count += delta\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  [Symbol.iterator]: -> yield segment for segment in @segments; return null\n\n  #=========================================================================================================\n  #\n  #---------------------------------------------------------------------------------------------------------\n  drive: ( cfg ) ->\n    throw new Error \"^moonriver@12^ pipeline is not repeatable\" unless @sources_are_repeatable\n    @turns++\n    for collection in [ @segments, @on_once_before_first, @on_once_after_last, ]\n      for segment in collection\n        segment.set_call_count  0\n        segment.set_is_over     false\n    #.......................................................................................................\n    for segment in @on_once_before_first\n      segment.call symbol.drop; R = @_drive { continue: true, }\n    R = @_drive cfg\n    for segment in @on_once_after_last\n      segment.call symbol.drop; R = @_drive { continue: true, }\n    return R\n\n  #---------------------------------------------------------------------------------------------------------\n  _drive: ( cfg ) ->\n    ### TAINT validate `cfg` ###\n    defaults        = { mode: 'breadth', first_idx: 0, last_idx: -1, }\n    cfg             = { defaults..., cfg..., }\n    first_idx       = cfg.first_idx\n    last_idx        = cfg.last_idx\n    last_idx        = if last_idx >= 0 then last_idx else @segments.length + last_idx\n    do_exit         = false\n    ### TAINT check for last_idx >= first_idx, last_idx < segments.length and so on ###\n    return null if @segments.length is 0\n    #.......................................................................................................\n    loop\n      for idx in [ first_idx .. last_idx ]\n        segment = @segments[ idx ]\n        # debug '^443^', ( @toString idx ), { XXX_count: @XXX_count, idx, data_count: @data_count, }, segment\n        #...................................................................................................\n        # if ( segment.is_over or not segment.is_listener )\n        if segment.is_over\n          ### If current segment has signalled it's gone out of business for this lap or is not a listener\n          in the first place, route all data on its input queue to its output queue: ###\n          ### TAINT rewrite to single step operation using Array::splice() ###\n          ### TAINT taking non-listeners out of the pipeline would speed this up but also somehwat\n          complicate the construction ###\n          ### TAINT code duplication ###\n          segment._transfer()\n          continue\n        #...................................................................................................\n        if segment.is_source\n            ### If current segment is a source, trigger the transform with a discardable `drop` value: ###\n          if segment._has_input_data\n            ### TAINT code duplication ###\n            segment._transfer()\n          segment.call symbol.drop\n        #...................................................................................................\n        else\n          ### Otherwise, call transform with next value from input queue, if any; when in operational mode\n          `breadth`, repeat until input queue is empty: ###\n          while segment.input.length > 0\n            segment.call segment.input.shift()\n            break if cfg.mode is 'depth'\n        #...................................................................................................\n        ### Stop processing if the `exit` signal has been received: ###\n        if segment.exit then do_exit = true; break\n      break if do_exit\n      #.....................................................................................................\n      ### When all sources have called it quits and no more input queues have data, end processing: ###\n      ### TAINT collect stats in above loop ###\n      break if ( @data_count is 0 ) and ( @sources.every ( source ) -> source.is_over )\n    # #.......................................................................................................\n    # ### Call all transforms that have the `last` modifier, then all transforms with the `once_after`\n    # modifier, skipping those that have signalled `over` or `exit`: ###\n    # ### TAINT make `last` and `once_after` mutually exclusive ###\n    # for segment in @on_last\n    #   continue if segment.is_over or segment.exit\n    #   segment.is_over = true\n    #   segment.call segment.modifiers.last, false\n    #.......................................................................................................\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  send: ( d ) ->\n    @segments[ 0 ].input.push d unless d is symbol.drop\n    @_drive()\n\n  #=========================================================================================================\n  #\n  #---------------------------------------------------------------------------------------------------------\n  [UTIL.inspect.custom]: -> @toString()\n\n  #---------------------------------------------------------------------------------------------------------\n  toString: ( current_idx ) ->\n    parts       = []\n    joiner      = CND.grey ' ▶︎ '\n    prv_output  = null\n    for segment, idx in @segments\n      parts.push CND.green rpr segment.input unless segment.input is prv_output\n      parts.push \\\n        if idx is current_idx then CND.reverse  CND.gold segment._name_of_transform() \\\n        else                                    CND.gold segment._name_of_transform()\n      parts.push CND.green rpr segment.output\n      prv_output = segment.output\n    return parts.join joiner\n    # return parts.join ' — '\n\n\n\n\n############################################################################################################\nmodule.exports = { Moonriver, Segment, Duct, }\n\n\n"
  ]
}