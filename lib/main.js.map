{
  "version": 3,
  "file": "",
  "sourceRoot": "",
  "sources": [
    "../src/main.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "\n'use strict'\n\n\n############################################################################################################\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'MOONRIVER'\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\ninfo                      = CND.get_logger 'info',      badge\nurge                      = CND.get_logger 'urge',      badge\nhelp                      = CND.get_logger 'help',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\necho                      = CND.echo.bind CND\nGUY                       = require 'guy'\ntypes                     = new ( require 'intertype' ).Intertype()\n{ isa\n  type_of\n  validate }              = types\nsymbol                    = GUY.lft.freeze\n  misfit:     Symbol.for 'misfit' # this value indicates absence of a value so can use `null`, `undefined`\n  drop:       Symbol.for 'drop'   # this value will not go to output\n  exit:       Symbol.for 'exit'   # exit pipeline processing\n  # done:       Symbol.for 'done' # done for this iteration\n  over:       Symbol.for 'over'   # do not call again in this round\n\n\n\n#===========================================================================================================\n#\n#-----------------------------------------------------------------------------------------------------------\nclass Modifications\n\n  #---------------------------------------------------------------------------------------------------------\n  @C = GUY.lft.freeze\n    defaults:\n      modifications:\n        once_before:  symbol.misfit\n        first:        symbol.misfit\n        last:         symbol.misfit\n        once_after:   symbol.misfit\n\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ( modifications..., transform ) ->\n    @modifications                = { @constructor.C.defaults.modifications..., modifications..., }\n    @modifications.do_once_before = @modifications.once_before  isnt symbol.misfit\n    @modifications.do_first       = @modifications.first        isnt symbol.misfit\n    @modifications.do_last        = @modifications.last         isnt symbol.misfit\n    @modifications.do_once_after  = @modifications.once_after   isnt symbol.misfit\n    @transform                    = transform\n    return undefined\n\n\n# #===========================================================================================================\n# #\n# #-----------------------------------------------------------------------------------------------------------\n# class @Classmethods\n\n#   # #---------------------------------------------------------------------------------------------------------\n#   # @$once = ( f ) ->\n\n\n#===========================================================================================================\n#\n#-----------------------------------------------------------------------------------------------------------\nclass @Moonriver # extends @Classmethods\n\n  #---------------------------------------------------------------------------------------------------------\n  @$: ( modifications..., transform ) -> new Modifications modifications..., transform\n\n  #---------------------------------------------------------------------------------------------------------\n  @C = GUY.lft.freeze\n    symbol: symbol\n\n  #---------------------------------------------------------------------------------------------------------\n  constructor: ( raw_pipeline ) ->\n    # super()\n    @first_input    = []\n    @last_output    = []\n    @pipeline       = []\n    last_idx        = raw_pipeline.length - 1\n    @inputs         = []\n    @sources        = []\n    @on_last        = []\n    @on_once_before = []\n    @on_once_after  = []\n    @user           = {} ### user area for sharing state between transforms, etc ###\n    @run_count      = 0\n    @is_repeatable  = true\n    for raw_transform, idx in raw_pipeline\n      { is_sender\n        is_source\n        modifications\n        transform     } = @_get_transform raw_transform\n      do ( is_sender, is_source, modifications, transform, idx ) =>\n        arity       = transform.length\n        input       = if idx is 0         then @first_input else @pipeline[ idx - 1 ].output\n        output      = if idx is last_idx  then @last_output else []\n        is_listener = not ( modifications.do_once_before or modifications.do_once_after )\n        segment     = { modifications, transform, arity, input, output, \\\n                          over: false, exit: false, is_sender, is_source, }\n        #...................................................................................................\n        if is_sender\n          if modifications.do_once_after\n            throw new Error \"^moonriver@1^ transforms with modifier once_after cannot be senders\"\n          call = ( d ) ->\n            @send.call_count++\n            if ( @send.call_count is 1 ) and @modifications.do_first\n              @transform @modifications.first, @send\n            @transform d, @send\n            return null\n        #...................................................................................................\n        else\n          call = ( d ) ->\n            @send.call_count++\n            if ( @send.call_count is 1 ) and @modifications.do_first\n              @transform @modifications.first\n            @transform d\n            @send d if ( not @modifications.do_once_before ) and ( not @modifications.do_once_after )\n            return null\n        #...................................................................................................\n        call        = call.bind segment\n        send        = ( d ) ->\n          switch d\n            when symbol.drop  then  null\n            when symbol.over  then  @over = true\n            when symbol.exit  then  @exit = true\n            else\n              throw new Error \"^moonriver@2^ cannot send values after pipeline has terminated\" if @over\n              @output.push d\n          return null\n        send            = send.bind segment\n        send.symbol     = symbol\n        send.over       = -> send send.symbol.over\n        send.exit       = -> send send.symbol.exit\n        send.call_count = 0\n        GUY.props.hide segment, 'send', send\n        GUY.props.hide segment, 'call', call\n        @pipeline.push        segment\n        @on_once_before.push  segment if modifications.do_once_before\n        @on_once_after.push   segment if modifications.do_once_after\n        @on_last.push         segment if modifications.do_last\n        @sources.push         segment if is_source\n        @inputs.push    input\n    return undefined\n\n  #---------------------------------------------------------------------------------------------------------\n  _get_transform: ( raw_transform ) ->\n    if ( type_of raw_transform ) is 'modifications'\n      modifications = raw_transform.modifications\n      transform     = @_get_transform_2 raw_transform.transform\n    else\n      modifications = ( new Modifications -> ).modifications\n      transform     = @_get_transform_2 raw_transform\n    #.......................................................................................................\n    return { modifications, transform..., }\n\n  #---------------------------------------------------------------------------------------------------------\n  _get_transform_2: ( raw_transform ) ->\n    is_source     = false\n    is_sender     = true\n    switch type = type_of raw_transform\n      when 'function'\n        switch ( arity = raw_transform.length )\n          when 0\n            throw new Error \"^moonriver@3^ zero-arity transform not implemented\"\n          when 1\n            is_sender = false\n            transform = raw_transform\n          when 2\n            transform = raw_transform\n          else\n            throw new Error \"^moonriver@4^ expected function with arity 2 got one with arity #{arity}\"\n      when 'generatorfunction'\n        is_source       = true\n        transform       = @_source_from_generatorfunction raw_transform\n        unless ( arity = transform.length ) is 2\n          throw new Error \"^moonriver@5^ expected function with arity 2 got one with arity #{arity}\"\n      when 'list'\n        is_source       = true\n        transform       = @_source_from_list raw_transform\n      else\n        if ( type is 'generator' ) or ( isa.function raw_transform[ Symbol.iterator ] )\n          @is_repeatable  = false\n          is_source       = true\n          transform       = @_source_from_generator raw_transform\n          unless ( arity = transform.length ) is 2\n            throw new Error \"^moonriver@6^ expected function with arity 2 got one with arity #{arity}\"\n        else\n          throw new Error \"^moonriver@7^ cannot convert a #{type} to a source\"\n    transform = transform.bind @\n    return { is_sender, is_source, transform, }\n\n  #---------------------------------------------------------------------------------------------------------\n  _source_from_generatorfunction: ( generatorfunction ) ->\n    generator = null\n    return generatorfunction_source = ( d, send ) ->\n      generator ?= generatorfunction()\n      send d\n      { value\n        done  } = generator.next()\n      ### NOTE silently discards value of `return` where present in keeping with JS `for of` loops ###\n      return send value unless done\n      generator = null\n      send.over()\n      return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _source_from_generator: ( generator ) ->\n    return generator_source = ( d, send ) ->\n      send d\n      { value\n        done  } = generator.next()\n      ### NOTE silently discards value of `return` where present in keeping with JS `for of` loops ###\n      return send value unless done\n      send.over()\n      return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _source_from_list: ( list ) ->\n    last_idx  = list.length - 1\n    idx       = -1\n    return list_source = ( d, send ) ->\n      send d\n      idx++\n      if idx > last_idx\n        idx = -1\n        return send.over()\n      send list[ idx ]\n      return null\n\n  #---------------------------------------------------------------------------------------------------------\n  can_repeat: -> @run_count is 0 or @repeatable\n\n  #---------------------------------------------------------------------------------------------------------\n  _on_drive_start: ->\n    return false unless @can_repeat()\n    @run_count++\n    return true\n\n  #---------------------------------------------------------------------------------------------------------\n  drive: ( cfg ) ->\n    ### TAINT validate `cfg` ###\n    throw new Error \"^moonriver@8^ pipeline is not repeatable\" unless @_on_drive_start()\n    defaults      = { mode: 'depth', }\n    { mode      } = { defaults..., cfg..., }\n    segment.over  = false for segment in @pipeline\n    do_exit       = false\n    #.......................................................................................................\n    for segment in @on_once_before\n      segment.call segment.modifications.once_before\n    #.......................................................................................................\n    loop\n      for segment in @pipeline\n        #...................................................................................................\n        if segment.over\n          ### If current segment has signalled it's gone out of business for this lap, route all data on its\n          input queue to its output queue: ###\n          ### TAINT rewrite to single step operation using Array::splice() ###\n          segment.output.push segment.input.shift() while segment.input.length > 0\n          continue\n        #...................................................................................................\n        if segment.is_source and segment.input.length is 0\n          ### If current segment is a source and no inputs are waiting to be sent, trigger the transform by\n          calling  with a discardable `drop` value: ###\n          segment.call symbol.drop\n        #...................................................................................................\n        else\n          ### Otherwise, call transform with next value from input queue, if any; when in operational mode\n          `breadth`, repeat until input queue is empty: ###\n          while segment.input.length > 0\n            segment.call segment.input.shift()\n            break if mode is 'depth'\n        #...................................................................................................\n        ### Discard any data that has made it to the final output queue of the pipeline: ###\n        @last_output.length = 0 if @last_output.length isnt 0\n        #...................................................................................................\n        ### Stop processing if the `exit` signal has been received: ###\n        if segment.exit then do_exit = true; break\n      break if do_exit\n      #.....................................................................................................\n      ### When all sources have called it quits and no more input queues have data, end processing: ###\n      ### TAINT collect stats in above loop ###\n      if @sources.every ( source ) -> source.over\n        unless @inputs.some ( input ) -> input.length > 0\n          break\n    #.......................................................................................................\n    ### Call all transforms that have the `last` modifier, then all transforms with the `once_after`\n    modifier, skipping those that have signalled `over` or `exit`: ###\n    ### TAINT make `last` and `once_after` mutually exclusive ###\n    for segment in @on_last\n      continue if segment.over or segment.exit\n      segment.over = true\n      segment.call segment.modifications.last\n    #.......................................................................................................\n    for segment in @on_once_after\n      continue if segment.over or segment.exit\n      segment.over = true\n      segment.call segment.modifications.once_after\n    #.......................................................................................................\n    return null\n\n  #---------------------------------------------------------------------------------------------------------\n  _show_pipeline: ->\n    urge @inputs[ 0 ]\n    for segment in @pipeline\n      urge segment.transform.name ? '?', segment.output\n    return null\n\n\n\n\n"
  ]
}